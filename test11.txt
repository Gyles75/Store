<mxfile host="app.diagrams.net">
  <diagram name="Flux OIDC Complet - Toutes Phases" id="complete-flow">
    <mxGraphModel dx="3500" dy="2500" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="3200" pageHeight="5500">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>
        
        <!-- HEADER -->
        <mxCell id="main-header-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#1A237E;strokeColor=none;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="30" width="3120" height="120" as="geometry"/>
        </mxCell>
        
        <mxCell id="main-title" value="ðŸ” FLUX D'AUTHENTIFICATION OIDC MULTI-TENANT - CRÃ‰DIT RENOUVELABLE" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=28;fontStyle=1;fontColor=#FFFFFF" vertex="1" parent="1">
          <mxGeometry x="40" y="50" width="3120" height="40" as="geometry"/>
        </mxCell>
        
        <mxCell id="subtitle" value="Du portail caisse jusqu'aux donnÃ©es mÃ©tier CACF - Parcours complet dÃ©taillÃ©" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=2;fontColor=#B3E5FC" vertex="1" parent="1">
          <mxGeometry x="40" y="95" width="3120" height="30" as="geometry"/>
        </mxCell>
        
        <!-- ZONES -->
        <mxCell id="zone-caisse" value="" style="rounded=2;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#2E7D32;strokeWidth=4;opacity=15;" vertex="1" parent="1">
          <mxGeometry x="40" y="180" width="1520" height="5050" as="geometry"/>
        </mxCell>
        
        <mxCell id="zone-caisse-header" value="ðŸ¦ INFRASTRUCTURE CAISSE RÃ‰GIONALE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#43A047;strokeColor=#1B5E20;strokeWidth=3;fontColor=#FFFFFF;fontSize=18;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="60" y="200" width="1480" height="50" as="geometry"/>
        </mxCell>
        
        <mxCell id="zone-cacf" value="" style="rounded=2;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#E65100;strokeWidth=4;opacity=15;" vertex="1" parent="1">
          <mxGeometry x="1600" y="180" width="1560" height="5050" as="geometry"/>
        </mxCell>
        
        <mxCell id="zone-cacf-header" value="ðŸ”§ INFRASTRUCTURE CACF/CAPFM (VOUS)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FB8C00;strokeColor=#E65100;strokeWidth=3;fontColor=#FFFFFF;fontSize=18;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1620" y="200" width="1520" height="50" as="geometry"/>
        </mxCell>
        
        <!-- ACTEURS -->
        <mxCell id="user-box" value="ðŸ‘¤\nUtilisateur\nClient CA" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#1976D2;strokeColor=#0D47A1;strokeWidth=3;fontColor=#FFFFFF;fontSize=13;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="100" y="280" width="140" height="100" as="geometry"/>
        </mxCell>
        
        <mxCell id="portail-box" value="ðŸŒ\nPortail\nCaisse\nhom1-npc.ca.fr" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#388E3C;strokeColor=#1B5E20;strokeWidth=3;fontColor=#FFFFFF;fontSize=12;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="300" y="280" width="160" height="100" as="geometry"/>
        </mxCell>
        
        <mxCell id="idp-caisse-box" value="ðŸ”\nIdP Caisse\nOIDC Server\nca-connect.ca.fr" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F9A825;strokeColor=#F57F17;strokeWidth=3;fontColor=#FFFFFF;fontSize=12;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="520" y="280" width="160" height="100" as="geometry"/>
        </mxCell>
        
        <mxCell id="lanceur-box" value="ðŸš€\nLanceur\nMyCA\nlanceur-sav.ca.fr" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#8E24AA;strokeColor=#4A148C;strokeWidth=3;fontColor=#FFFFFF;fontSize=12;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="740" y="280" width="160" height="100" as="geometry"/>
        </mxCell>
        
        <mxCell id="bff-lanceur-box" value="âš™ï¸\nBFF\nLanceur\n/bff/lanceur/" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#D32F2F;strokeColor=#B71C1C;strokeWidth=3;fontColor=#FFFFFF;fontSize=12;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="960" y="280" width="160" height="100" as="geometry"/>
        </mxCell>
        
        <mxCell id="iframe-sep" value="&lt;iframe&gt;" style="endArrow=none;dashed=1;html=1;strokeWidth=6;strokeColor=#9C27B0;dashPattern=12 12;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1300" y="280" as="sourcePoint"/>
            <mxPoint x="1300" y="5230" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="microfront-box" value="ðŸ’»\nMicrofront\nVue 3\nrct.sav-crtconso" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#6A1B9A;strokeColor=#4A148C;strokeWidth=3;fontColor=#FFFFFF;fontSize=12;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1660" y="280" width="180" height="100" as="geometry"/>
        </mxCell>
        
        <mxCell id="bff-cacf-box" value="ðŸ”§\nBFF Node.js\n22\n/api/npc/" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#EF6C00;strokeColor=#E65100;strokeWidth=3;fontColor=#FFFFFF;fontSize=12;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1900" y="280" width="180" height="100" as="geometry"/>
        </mxCell>
        
        <mxCell id="idp-wso2-box" value="ðŸ”‘\nIdP CACF\nWSO2 IS\nrct-api-ca-cf" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#0288D1;strokeColor=#01579B;strokeWidth=3;fontColor=#FFFFFF;fontSize=12;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2140" y="280" width="180" height="100" as="geometry"/>
        </mxCell>
        
        <mxCell id="apis-box" value="ðŸ“Š\nAPIs MÃ©tier\nSOFINCO\nrct-api.sofinco" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#388E3C;strokeColor=#1B5E20;strokeWidth=3;fontColor=#FFFFFF;fontSize=12;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2380" y="280" width="180" height="100" as="geometry"/>
        </mxCell>
        
        <!-- LIGNES DE VIE -->
        <mxCell id="life-1" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=3;strokeColor=#1976D2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="170" y="410" as="sourcePoint"/>
            <mxPoint x="170" y="5200" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="life-2" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=3;strokeColor=#388E3C;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="380" y="410" as="sourcePoint"/>
            <mxPoint x="380" y="5200" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="life-3" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=3;strokeColor=#F9A825;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="600" y="410" as="sourcePoint"/>
            <mxPoint x="600" y="5200" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="life-4" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=3;strokeColor=#8E24AA;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="820" y="410" as="sourcePoint"/>
            <mxPoint x="820" y="5200" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="life-5" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=3;strokeColor=#D32F2F;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1040" y="410" as="sourcePoint"/>
            <mxPoint x="1040" y="5200" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="life-6" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=3;strokeColor=#6A1B9A;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1750" y="410" as="sourcePoint"/>
            <mxPoint x="1750" y="5200" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="life-7" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=3;strokeColor=#EF6C00;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1990" y="410" as="sourcePoint"/>
            <mxPoint x="1990" y="5200" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="life-8" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=3;strokeColor=#0288D1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2230" y="410" as="sourcePoint"/>
            <mxPoint x="2230" y="5200" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="life-9" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=3;strokeColor=#388E3C;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2470" y="410" as="sourcePoint"/>
            <mxPoint x="2470" y="5200" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <!-- ===== PHASE 1 ===== -->
        <mxCell id="p1-bg" value="" style="rounded=2;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1976D2;strokeWidth=3;opacity=20;" vertex="1" parent="1">
          <mxGeometry x="60" y="450" width="3080" height="600" as="geometry"/>
        </mxCell>
        
        <mxCell id="p1-title" value="ðŸ”µ PHASE 1 : AUTHENTIFICATION INITIALE PORTAIL CAISSE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#1976D2;strokeColor=#0D47A1;strokeWidth=3;fontColor=#FFFFFF;fontSize=16;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="470" width="3040" height="45" as="geometry"/>
        </mxCell>
        
        <mxCell id="p1-desc" value="L'utilisateur accÃ¨de au portail web de sa caisse rÃ©gionale. Si aucune session n'existe, il s'authentifie via formulaire (numÃ©ro compte + code). Sinon, le SSO rÃ©utilise sa session." style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1565C0;strokeWidth=2;fontSize=13;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="100" y="530" width="3000" height="40" as="geometry"/>
        </mxCell>
        
        <!-- 1.1 -->
        <mxCell id="a1-1" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#388E3C;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="175" y="600" as="sourcePoint"/>
            <mxPoint x="375" y="600" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l1-1" value="1ï¸âƒ£ AccÃ¨s portail" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#388E3C;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="200" y="575" width="120" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d1-1" value="ðŸ–±ï¸ L'utilisateur ouvre https://hom1-npc.credit-agricole.fr/ca-centrest/" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#E8F5E9;strokeColor=#2E7D32;fontSize=10;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="200" y="625" width="300" height="40" as="geometry"/>
        </mxCell>
        
        <!-- 1.2 -->
        <mxCell id="a1-2" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#F9A825;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="385" y="700" as="sourcePoint"/>
            <mxPoint x="595" y="700" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l1-2" value="2ï¸âƒ£ Flux OIDC" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#F9A825;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="420" y="675" width="100" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d1-2" value="GET /authorize_successive?client_id=8f0f2f56...&amp;redirect_uri=...callback.iidc" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#FFFDE7;strokeColor=#F57F17;fontSize=9;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="420" y="725" width="300" height="40" as="geometry"/>
        </mxCell>
        
        <!-- 1.3 -->
        <mxCell id="a1-3" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#F9A825;dashed=1;dashPattern=8 4;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="595" y="800" as="sourcePoint"/>
            <mxPoint x="385" y="800" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l1-3" value="3ï¸âƒ£ Form login" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#F9A825;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="425" y="775" width="110" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d1-3" value="ðŸ”’ Formulaire (si pas de session SSO) ou redirect direct" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#FFFDE7;strokeColor=#F57F17;fontSize=10;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="200" y="825" width="280" height="35" as="geometry"/>
        </mxCell>
        
        <!-- 1.4 -->
        <mxCell id="a1-4" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#F9A825;dashed=1;dashPattern=8 4;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="595" y="900" as="sourcePoint"/>
            <mxPoint x="385" y="900" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l1-4" value="4ï¸âƒ£ Code auth" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#F9A825;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="430" y="875" width="100" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d1-4" value="code=cfae3799-662b...&amp;redirect_uri=.../callback.iidc (valide 5 min)" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#FFFDE7;strokeColor=#F57F17;fontSize=9;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="200" y="925" width="280" height="40" as="geometry"/>
        </mxCell>
        
        <!-- 1.5 -->
        <mxCell id="a1-5" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#388E3C;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="385" y="1000" as="sourcePoint"/>
            <mxPoint x="385" y="1030" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l1-5" value="5ï¸âƒ£ Session OK" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#388E3C;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="300" y="1005" width="100" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d1-5" value="âœ… Session SSO active - L'utilisateur est authentifiÃ© sur le portail" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#E8F5E9;strokeColor=#2E7D32;fontSize=10;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="520" y="985" width="300" height="40" as="geometry"/>
        </mxCell>
        
        <!-- ===== PHASE 2 ===== -->
        <mxCell id="p2-bg" value="" style="rounded=2;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#7B1FA2;strokeWidth=3;opacity=20;" vertex="1" parent="1">
          <mxGeometry x="60" y="1090" width="3080" height="650" as="geometry"/>
        </mxCell>
        
        <mxCell id="p2-title" value="ðŸŸ£ PHASE 2 : ORCHESTRATION VIA LANCEUR MyCA" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#7B1FA2;strokeColor=#4A148C;strokeWidth=3;fontColor=#FFFFFF;fontSize=16;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="1110" width="3040" height="45" as="geometry"/>
        </mxCell>
        
        <mxCell id="p2-desc" value="L'utilisateur clique sur 'CrÃ©dit Renouvelable'. Le portail redirige vers le Lanceur MyCA qui va s'authentifier, puis gÃ©nÃ©rer un JWT signÃ© avec certificats X.509." style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#6A1B9A;strokeWidth=2;fontSize=13;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="100" y="1170" width="3000" height="40" as="geometry"/>
        </mxCell>
        
        <!-- 2.1 -->
        <mxCell id="a2-1" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#8E24AA;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="385" y="1250" as="sourcePoint"/>
            <mxPoint x="815" y="1250" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l2-1" value="6ï¸âƒ£ Vers Lanceur" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#8E24AA;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="520" y="1225" width="120" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d2-1" value="GET /lanceur?context_id=940cbd88-c2a9... (ID de session unique)" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#F3E5F5;strokeColor=#7B1FA2;fontSize=10;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="520" y="1275" width="320" height="40" as="geometry"/>
        </mxCell>
        
        <!-- 2.2 -->
        <mxCell id="a2-2" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#F9A825;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="820" y="1360" as="sourcePoint"/>
            <mxPoint x="605" y="1360" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l2-2" value="7ï¸âƒ£ Auth Lanceur" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#F9A825;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="650" y="1335" width="120" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d2-2" value="GET /authorize?client_id=02274bc8...&amp;scope=openid&amp;marche_derive=particulier&#xa;Le Lanceur doit s'authentifier pour obtenir ses droits" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#FFFDE7;strokeColor=#F57F17;fontSize=9;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="520" y="1385" width="350" height="50" as="geometry"/>
        </mxCell>
        
        <!-- 2.3 -->
        <mxCell id="a2-3" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#F9A825;dashed=1;dashPattern=8 4;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="605" y="1480" as="sourcePoint"/>
            <mxPoint x="820" y="1480" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l2-3" value="8ï¸âƒ£ Code auth" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#F9A825;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="650" y="1455" width="110" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d2-3" value="code=1fbadccc-3bb8...&amp;state=fd547d87... (SSO = instantanÃ©)" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#FFFDE7;strokeColor=#F57F17;fontSize=10;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="650" y="1505" width="300" height="35" as="geometry"/>
        </mxCell>
        
        <!-- 2.4 -->
        <mxCell id="a2-4" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#D32F2F;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="825" y="1590" as="sourcePoint"/>
            <mxPoint x="1035" y="1590" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l2-4" value="9ï¸âƒ£ POST /login" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#D32F2F;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="860" y="1565" width="110" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d2-4" value="POST /bff/lanceur-myca/security/login&#xa;Body: {code, state, redirectUrl}&#xa;â†’ BFF Ã©change code contre tokens&#xa;â†’ BFF gÃ©nÃ¨re JWT avec certificats X.509" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#FFEBEE;strokeColor=#C62828;fontSize=9;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="860" y="1615" width="280" height="70" as="geometry"/>
        </mxCell>
        
        <!-- 2.5 JWT Generation Process -->
        <mxCell id="jwt-gen-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#D32F2F;strokeWidth=3;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="200" y="1590" width="380" height="130" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-gen-title" value="ðŸ” GÃ‰NÃ‰RATION JWT SIGNÃ‰" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=12;fontStyle=1;fontColor=#B71C1C" vertex="1" parent="1">
          <mxGeometry x="200" y="1595" width="380" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-gen-1" value="1. Charge 3 certificats X.509 depuis keystore" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="210" y="1620" width="360" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-gen-2" value="2. Construit payload JWT (sub hashÃ© + params mÃ©tier)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="210" y="1640" width="360" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-gen-3" value="3. Header JWT: alg=RS256, x5c=[cert1,cert2,cert3]" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="210" y="1660" width="360" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-gen-4" value="4. Signe avec clÃ© privÃ©e du cert1 (Lanceur)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="210" y="1680" width="360" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-gen-5" value="5. Retourne JWT complet (plusieurs Ko)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontStyle=1;fontColor=#B71C1C" vertex="1" parent="1">
          <mxGeometry x="210" y="1700" width="360" height="18" as="geometry"/>
        </mxCell>
        
        <!-- ===== PHASE 3 ===== -->
        <mxCell id="p3-bg" value="" style="rounded=2;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#E65100;strokeWidth=3;opacity=20;" vertex="1" parent="1">
          <mxGeometry x="60" y="1780" width="3080" height="500" as="geometry"/>
        </mxCell>
        
        <mxCell id="p3-title" value="ðŸŸ  PHASE 3 : APPEL MICROFRONT AVEC JWT SIGNÃ‰" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E65100;strokeColor=#BF360C;strokeWidth=3;fontColor=#FFFFFF;fontSize=16;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="1800" width="3040" height="45" as="geometry"/>
        </mxCell>
        
        <mxCell id="p3-desc" value="Le BFF Lanceur transmet le JWT signÃ© Ã  votre BFF Node.js. Ce JWT contient le contexte utilisateur + chaÃ®ne de 3 certificats X.509 pour validation cryptographique." style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCCBC;strokeColor=#D84315;strokeWidth=2;fontSize=13;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="100" y="1860" width="3000" height="40" as="geometry"/>
        </mxCell>
        
        <!-- 3.1 -->
        <mxCell id="a3-1" value="" style="endArrow=classic;html=1;strokeWidth=6;strokeColor=#EF6C00;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1045" y="1940" as="sourcePoint"/>
            <mxPoint x="1985" y="1940" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l3-1" value="ðŸ”Ÿ POST /api/npc/docker" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#EF6C00;strokeWidth=3;fontSize=12;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1380" y="1910" width="180" height="25" as="geometry"/>
        </mxCell>
        <mxCell id="d3-1" value="POST /summary/api/npc/docker&#xa;Body:&#xa;  request_version=3&#xa;  correlation_id=bc65d99f-6fd6... (traÃ§age)&#xa;  user_idp_hint=https://hom-private.api... (URL IdP)&#xa;  ihm_launch_params=eyJhbGci... (JWT COMPLET)&#xa;&#xa;ðŸ’¡ JWT = plusieurs Ko avec certificats" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#FFF3E0;strokeColor=#E65100;fontSize=9;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1380" y="1970" width="350" height="110" as="geometry"/>
        </mxCell>
        
        <!-- 3.2 decodeNpcContext Process -->
        <mxCell id="decode-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCCBC;strokeColor=#E65100;strokeWidth=3;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1900" y="2100" width="420" height="160" as="geometry"/>
        </mxCell>
        <mxCell id="decode-title" value="âš™ï¸ decodeNpcContext()" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=13;fontStyle=1;fontColor=#BF360C" vertex="1" parent="1">
          <mxGeometry x="1900" y="2105" width="420" height="22" as="geometry"/>
        </mxCell>
        <mxCell id="decode-1" value="1ï¸âƒ£ Clear cookies (refreshToken = null)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1915" y="2135" width="390" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="decode-2" value="2ï¸âƒ£ Stocke JWT en session: session.context = jwt" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1915" y="2160" width="390" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="decode-3" value="3ï¸âƒ£ Stocke correlation_id en session" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1915" y="2185" width="390" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="decode-4" value="4ï¸âƒ£ Construit params OIDC: fidp=base64(user_idp_hint)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1915" y="2210" width="390" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="decode-5" value="5ï¸âƒ£ Redirige vers IdP WSO2 (PAS de validation JWT ici)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontStyle=1;fontColor=#BF360C" vertex="1" parent="1">
          <mxGeometry x="1915" y="2235" width="390" height="20" as="geometry"/>
        </mxCell>
        
        <!-- ===== PHASE 4 ===== -->
        <mxCell id="p4-bg" value="" style="rounded=2;whiteSpace=wrap;html=1;fillColor=#E1F5FE;strokeColor=#0277BD;strokeWidth=3;opacity=20;" vertex="1" parent="1">
          <mxGeometry x="60" y="2320" width="3080" height="750" as="geometry"/>
        </mxCell>
        
        <mxCell id="p4-title" value="ðŸ”µ PHASE 4 : FÃ‰DÃ‰RATION D'IDENTITÃ‰ OIDC (WSO2 â†” IdP CAISSE)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#0277BD;strokeColor=#01579B;strokeWidth=3;fontColor=#FFFFFF;fontSize=16;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="2340" width="3040" height="45" as="geometry"/>
        </mxCell>
        
        <mxCell id="p4-desc" value="WSO2 dÃ©tecte le paramÃ¨tre 'fidp' (Federated IdP) et DÃ‰LÃˆGUE l'authentification Ã  l'IdP de la caisse. C'est la FÃ‰DÃ‰RATION : WSO2 fait CONFIANCE Ã  l'IdP caisse." style="rounded=1;whiteSpace=wrap;html=1;fillColor=#B3E5FC;strokeColor=#0288D1;strokeWidth=2;fontSize=13;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="100" y="2400" width="3000" height="40" as="geometry"/>
        </mxCell>
        
        <!-- 4.1 -->
        <mxCell id="a4-1" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#0288D1;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1995" y="2490" as="sourcePoint"/>
            <mxPoint x="2225" y="2490" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l4-1" value="1ï¸âƒ£1ï¸âƒ£ Vers WSO2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#0288D1;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2050" y="2465" width="110" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d4-1" value="GET /authorize?&#xa;  client_id=SHVQYbMY6bNeEGmA...&#xa;  state=bc65d99f... (correlation_id)&#xa;  redirect_uri=/api/npc/transco&#xa;  scope=openid user-ca&#xa;  fidp=aHR0cHM6Ly9ob20tcHJpd... (BASE64)&#xa;&#xa;ðŸ’¡ fidp dÃ©codÃ© = URL IdP caisse" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#E1F5FE;strokeColor=#0277BD;fontSize=9;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2050" y="2520" width="300" height="110" as="geometry"/>
        </mxCell>
        
        <mxCell id="fidp-note" value="ðŸ”— FEDERATED IDP&#xa;&#xa;Le paramÃ¨tre 'fidp' indique Ã  WSO2&#xa;de NE PAS authentifier l'utilisateur&#xa;lui-mÃªme, mais de DÃ‰LÃ‰GUER&#xa;l'authentification Ã  l'IdP externe&#xa;(celui de la caisse rÃ©gionale)" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#FFF9C4;strokeColor=#F57F17;fontSize=11;fontStyle=1;align=center;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2400" y="2520" width="250" height="110" as="geometry"/>
        </mxCell>
        
        <!-- 4.2 -->
        <mxCell id="a4-2" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#F9A825;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2225" y="2680" as="sourcePoint"/>
            <mxPoint x="605" y="2680" as="targetPoint"/>
            <Array as="points">
              <mxPoint x="1415" y="2640"/>
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="l4-2" value="1ï¸âƒ£2ï¸âƒ£ Vers IdP Caisse" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#F9A825;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1330" y="2615" width="140" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d4-2" value="GET /authorize?&#xa;  client_id=da500d39... (ID de WSO2)&#xa;  redirect_uri=.../commonauth (callback WSO2)&#xa;  state=912841f3-...,OIDC&#xa;  scope=openid user-ca&#xa;&#xa;ðŸ”„ WSO2 dÃ©lÃ¨gue l'authentification" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#FFFDE7;strokeColor=#F57F17;fontSize=9;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1180" y="2710" width="280" height="100" as="geometry"/>
        </mxCell>
        
        <!-- 4.3 -->
        <mxCell id="a4-3" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#F9A825;dashed=1;dashPattern=8 4;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="605" y="2850" as="sourcePoint"/>
            <mxPoint x="2225" y="2850" as="targetPoint"/>
            <Array as="points">
              <mxPoint x="1415" y="2900"/>
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="l4-3" value="1ï¸âƒ£3ï¸âƒ£ Code auth" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#F9A825;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1350" y="2875" width="110" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d4-3" value="code=81b0f2e6-affa... (SSO !)&#xa;â†’ WSO2 Ã©change code contre tokens&#xa;â†’ WSO2 valide identitÃ© dans id_token&#xa;â†’ WSO2 crÃ©e session locale" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#FFFDE7;strokeColor=#F57F17;fontSize=10;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1180" y="2830" width="280" height="60" as="geometry"/>
        </mxCell>
        
        <!-- 4.4 -->
        <mxCell id="a4-4" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#0288D1;dashed=1;dashPattern=8 4;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2225" y="2980" as="sourcePoint"/>
            <mxPoint x="1995" y="2980" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l4-4" value="1ï¸âƒ£4ï¸âƒ£ Code WSO2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#0288D1;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2030" y="2955" width="120" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d4-4" value="GET /api/npc/transco?&#xa;  code=770a841e-0dbf... (nouveau code WSO2!)&#xa;  state=bc65d99f... (correlation_id original)&#xa;  session_state=975511d8...&#xa;&#xa;âš ï¸ Code diffÃ©rent du code caisse !" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#E1F5FE;strokeColor=#0277BD;fontSize=9;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1650" y="3010" width="320" height="85" as="geometry"/>
        </mxCell>
        
        <!-- ===== PHASE 5 ===== -->
        <mxCell id="p5-bg" value="" style="rounded=2;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;strokeWidth=3;opacity=20;" vertex="1" parent="1">
          <mxGeometry x="60" y="3110" width="3080" height="900" as="geometry"/>
        </mxCell>
        
        <mxCell id="p5-title" value="ðŸ”´ PHASE 5 : TRANSCODAGE CONTEXT &amp; VALIDATION COMPLÃˆTE JWT" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C62828;strokeColor=#B71C1C;strokeWidth=3;fontColor=#FFFFFF;fontSize=16;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="3130" width="3040" height="45" as="geometry"/>
        </mxCell>
        
        <mxCell id="p5-desc" value="Votre BFF rÃ©cupÃ¨re le JWT depuis la session, effectue une validation cryptographique COMPLÃˆTE (6 niveaux), transcode les identifiants caisse â†’ CACF, et obtient les tokens OAuth finaux." style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#D32F2F;strokeWidth=2;fontSize=13;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="100" y="3190" width="3000" height="40" as="geometry"/>
        </mxCell>
        
        <!-- 5.1 transcodeContext Process -->
        <mxCell id="transco-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;strokeWidth=4;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1650" y="3260" width="480" height="720" as="geometry"/>
        </mxCell>
        <mxCell id="transco-title" value="ðŸ”§ transcodeContext() - Ã‰TAPES DÃ‰TAILLÃ‰ES" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=14;fontStyle=1;fontColor=#B71C1C" vertex="1" parent="1">
          <mxGeometry x="1650" y="3270" width="480" height="25" as="geometry"/>
        </mxCell>
        
        <mxCell id="transco-step1" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#D32F2F;strokeWidth=2;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1670" y="3310" width="440" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step1-title" value="Ã‰TAPE 1ï¸âƒ£ : RÃ©cupÃ©ration JWT" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=12;fontStyle=1;fontColor=#B71C1C" vertex="1" parent="1">
          <mxGeometry x="1680" y="3315" width="420" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step1-code" value="parsedToken = decodeFreestandingJwt(session.context)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontFamily=Courier New;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1680" y="3335" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step1-note" value="â†’ Validation 6 niveaux (voir encadrÃ© ci-dessous)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="1680" y="3352" width="420" height="16" as="geometry"/>
        </mxCell>
        
        <mxCell id="transco-step2" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#D32F2F;strokeWidth=2;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1670" y="3385" width="440" height="75" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step2-title" value="Ã‰TAPE 2ï¸âƒ£ : Validation AAT (Access Assertion Token)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=12;fontStyle=1;fontColor=#B71C1C" vertex="1" parent="1">
          <mxGeometry x="1680" y="3390" width="420" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step2-code" value="checkedAAT = await getAATAndCheck(code, parsedToken.sub)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontFamily=Courier New;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1680" y="3410" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step2-note1" value="â†’ Ã‰change code WSO2 contre tokens (access, id_token)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="1680" y="3427" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step2-note2" value="â†’ VÃ©rifie que id_token.sub == JWT.sub (anti-usurpation)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="1680" y="3444" width="420" height="16" as="geometry"/>
        </mxCell>
        
        <mxCell id="transco-step3" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#D32F2F;strokeWidth=2;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1670" y="3475" width="440" height="75" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step3-title" value="Ã‰TAPE 3ï¸âƒ£ : Transcodage Code Caisse RÃ©gionale" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=12;fontStyle=1;fontColor=#B71C1C" vertex="1" parent="1">
          <mxGeometry x="1680" y="3480" width="420" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step3-code" value="crCode = code_cr.substr(0, 3)  // 87800 â†’ 878" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontFamily=Courier New;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1680" y="3500" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step3-note1" value="â†’ Cas spÃ©cial: 90000 (Paris) devient 840" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="1680" y="3517" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step3-note2" value="â†’ Exemple: 12345 (Normandie) devient 123" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="1680" y="3534" width="420" height="16" as="geometry"/>
        </mxCell>
        
        <mxCell id="transco-step4" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#D32F2F;strokeWidth=2;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1670" y="3565" width="440" height="90" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step4-title" value="Ã‰TAPE 4ï¸âƒ£ : Mapping Identifiant CACF" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=12;fontStyle=1;fontColor=#B71C1C" vertex="1" parent="1">
          <mxGeometry x="1680" y="3570" width="420" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step4-code1" value="customerId = await getCacfCustomerId(" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontFamily=Courier New;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1680" y="3590" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step4-code2" value="  identifiant_partenaire,  // 00000302260493" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontFamily=Courier New;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1680" y="3607" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step4-code3" value="  crCode  // 878" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontFamily=Courier New;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1680" y="3624" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step4-code4" value=")  // Returns: 91308724636" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontFamily=Courier New;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1680" y="3641" width="420" height="16" as="geometry"/>
        </mxCell>
        
        <mxCell id="transco-step5" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#D32F2F;strokeWidth=2;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1670" y="3670" width="440" height="75" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step5-title" value="Ã‰TAPE 5ï¸âƒ£ : Obtention Tokens OAuth" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=12;fontStyle=1;fontColor=#B71C1C" vertex="1" parent="1">
          <mxGeometry x="1680" y="3675" width="420" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step5-code" value="tokens = await getUserAccessToken(req, res, customerId)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontFamily=Courier New;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1680" y="3695" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step5-note1" value="â†’ Appel API Manager CACF avec scope customer:{id}" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="1680" y="3712" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step5-note2" value="â†’ ReÃ§oit access_token + refresh_token" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="1680" y="3729" width="420" height="16" as="geometry"/>
        </mxCell>
        
        <mxCell id="transco-step6" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#D32F2F;strokeWidth=2;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1670" y="3760" width="440" height="90" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step6-title" value="Ã‰TAPE 6ï¸âƒ£ : Stockage Cookie + Redirection Finale" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=12;fontStyle=1;fontColor=#B71C1C" vertex="1" parent="1">
          <mxGeometry x="1680" y="3765" width="420" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step6-code1" value="res.cookie('refreshToken', tokens.refresh_token, {" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontFamily=Courier New;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1680" y="3785" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step6-code2" value="  httpOnly: true, maxAge: 300000  // 5 min" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontFamily=Courier New;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1680" y="3802" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step6-code3" value="})" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontFamily=Courier New;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1680" y="3819" width="420" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step6-note" value="â†’ Redirect: /summary/?params=eyJucGNDb... (base64)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="1680" y="3836" width="420" height="16" as="geometry"/>
        </mxCell>
        
        <mxCell id="transco-step7" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#2E7D32;strokeWidth=3;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1670" y="3865" width="440" height="105" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step7-title" value="âœ… RÃ‰SULTAT FINAL : Contexte Complet" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=12;fontStyle=1;fontColor=#1B5E20" vertex="1" parent="1">
          <mxGeometry x="1670" y="3870" width="440" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="transco-step7-data" value="npcContext: {&#xa;  connectedUserId: '00000302260493',&#xa;  crCode: '878', customerId: '91308724636',&#xa;  contractId: '70067497211',&#xa;  charterCode: 'V', partnerId: 'PortailClient'&#xa;}" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;fontFamily=Courier New;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1680" y="3895" width="420" height="70" as="geometry"/>
        </mxCell>
        
        <!-- JWT Validation Detail Box -->
        <mxCell id="jwt-valid-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=4;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="200" y="3260" width="1400" height="490" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-valid-title" value="ðŸ” VALIDATION JWT - 6 NIVEAUX DE SÃ‰CURITÃ‰ (decodeFreestandingJwt)" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=15;fontStyle=1;fontColor=#F57F17" vertex="1" parent="1">
          <mxGeometry x="200" y="3270" width="1400" height="25" as="geometry"/>
        </mxCell>
        
        <mxCell id="jwt-level1" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#FBC02D;strokeWidth=2;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="220" y="3310" width="660" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-level1-title" value="NIVEAU 1ï¸âƒ£ : DÃ©codage Structurel" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontStyle=1;fontColor=#F57F17" vertex="1" parent="1">
          <mxGeometry x="230" y="3315" width="640" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-level1-desc" value="VÃ©rifie que le JWT a 3 parties (header.payload.signature)&#xa;Parse le JSON sans vÃ©rifier la signature (decode, pas verify)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="230" y="3335" width="640" height="32" as="geometry"/>
        </mxCell>
        
        <mxCell id="jwt-level2" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#FBC02D;strokeWidth=2;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="220" y="3385" width="660" height="75" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-level2-title" value="NIVEAU 2ï¸âƒ£ : Extraction Certificats X.509" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontStyle=1;fontColor=#F57F17" vertex="1" parent="1">
          <mxGeometry x="230" y="3390" width="640" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-level2-desc" value="Extrait les 3 certificats PEM depuis header.x5c avec regex&#xa;Convertit en objets X.509 via node-forge&#xa;Permet l'inspection des propriÃ©tÃ©s (subject, validity, etc.)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="230" y="3410" width="640" height="48" as="geometry"/>
        </mxCell>
        
        <mxCell id="jwt-level3" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#FBC02D;strokeWidth=2;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="220" y="3475" width="660" height="75" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-level3-title" value="NIVEAU 3ï¸âƒ£ : ValiditÃ© Temporelle" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontStyle=1;fontColor=#F57F17" vertex="1" parent="1">
          <mxGeometry x="230" y="3480" width="640" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-level3-desc" value="VÃ©rifie notBefore et notAfter pour les 3 certificats&#xa;now >= cert.validity.notBefore &amp;&amp; now &amp;le; cert.validity.notAfter&#xa;Protection contre certificats expirÃ©s ou pas encore valides" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="230" y="3500" width="640" height="48" as="geometry"/>
        </mxCell>
        
        <mxCell id="jwt-level4" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#FBC02D;strokeWidth=2;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="220" y="3565" width="660" height="90" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-level4-title" value="NIVEAU 4ï¸âƒ£ : ChaÃ®ne de Confiance (PKI)" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontStyle=1;fontColor=#F57F17" vertex="1" parent="1">
          <mxGeometry x="230" y="3570" width="640" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-level4-desc" value="cert2.verify(cert1) â†’ Cert2 (CA) a-t-il signÃ© cert1 (Lanceur) ?&#xa;cert3.verify(cert2) â†’ Cert3 (Root) a-t-il signÃ© cert2 (CA) ?&#xa;ChaÃ®ne: Root CA â†’ CA IntermÃ©diaire â†’ Lanceur&#xa;Garantit que cert1 provient d'une autoritÃ© de confiance" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="230" y="3590" width="640" height="62" as="geometry"/>
        </mxCell>
        
        <mxCell id="jwt-level5" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#FBC02D;strokeWidth=2;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="910" y="3310" width="660" height="115" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-level5-title" value="NIVEAU 5ï¸âƒ£ : Whitelist Distinguished Names" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontStyle=1;fontColor=#F57F17" vertex="1" parent="1">
          <mxGeometry x="920" y="3315" width="640" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-level5-desc" value="Extrait DN de chaque certificat:&#xa;  'CN=OP_CATS_LANCEUR_MYCA_V2, OU=CATS, O=...'&#xa;Compare avec whitelists en variable d'environnement&#xa;EmpÃªche l'usurpation: mÃªme avec certificat valide,&#xa;s'il n'est pas whitelistÃ© â†’ REJET" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="920" y="3335" width="640" height="87" as="geometry"/>
        </mxCell>
        
        <mxCell id="jwt-level6" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#FBC02D;strokeWidth=2;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="910" y="3440" width="660" height="90" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-level6-title" value="NIVEAU 6ï¸âƒ£ : VÃ©rification Signature JWT" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontStyle=1;fontColor=#F57F17" vertex="1" parent="1">
          <mxGeometry x="920" y="3445" width="640" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="jwt-level6-desc" value="Extrait clÃ© publique de cert1 (Lanceur)&#xa;jwt.verify(token, publicKey) â†’ VÃ©rifie signature RS256&#xa;Confirme que le JWT a Ã©tÃ© signÃ© par la clÃ© privÃ©e du Lanceur&#xa;VALIDATION CRYPTOGRAPHIQUE FINALE" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="920" y="3465" width="640" height="62" as="geometry"/>
        </mxCell>
        
        <mxCell id="jwt-security-note" value="ðŸ›¡ï¸ SÃ‰CURITÃ‰ RENFORCÃ‰E : Ces 6 niveaux garantissent que le JWT est authentique,&#xa;non altÃ©rÃ©, provient du Lanceur autorisÃ©, et n'a pas expirÃ©." style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;strokeWidth=3;fontSize=12;fontStyle=1;align=center;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="910" y="3550" width="660" height="50" as="geometry"/>
        </mxCell>
        
        <mxCell id="jwt-cert-chain" value="ðŸ“œ CHAÃŽNE CERTIFICATS X.509:&#xa;Cert3 (Root): CN=RCA Credit Agricole Group&#xa;Cert2 (CA): CN=CA Credit Agricole Server&#xa;Cert1 (Lanceur): CN=OP_CATS_LANCEUR_MYCA_V2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1976D2;strokeWidth=2;fontSize=10;align=left;shadow=1;fontFamily=Courier New" vertex="1" parent="1">
          <mxGeometry x="910" y="3620" width="660" height="70" as="geometry"/>
        </mxCell>
        
        <mxCell id="jwt-why" value="â“ POURQUOI 6 NIVEAUX ?&#xa;â€¢ DÃ©fense en profondeur (defense in depth)&#xa;â€¢ ConformitÃ© sÃ©curitÃ© bancaire&#xa;â€¢ Protection contre rejeu, usurpation, altÃ©ration&#xa;â€¢ TraÃ§abilitÃ© et non-rÃ©pudiation" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#E65100;strokeWidth=2;fontSize=10;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="220" y="3670" width="660" height="75" as="geometry"/>
        </mxCell>
        
        <!-- ===== PHASE 6 ===== -->
        <mxCell id="p6-bg" value="" style="rounded=2;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#2E7D32;strokeWidth=3;opacity=20;" vertex="1" parent="1">
          <mxGeometry x="60" y="4050" width="3080" height="500" as="geometry"/>
        </mxCell>
        
        <mxCell id="p6-title" value="ðŸŸ¢ PHASE 6 : RÃ‰CUPÃ‰RATION DONNÃ‰ES MÃ‰TIER ET AFFICHAGE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#2E7D32;strokeColor=#1B5E20;strokeWidth=3;fontColor=#FFFFFF;fontSize=16;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="4070" width="3040" height="45" as="geometry"/>
        </mxCell>
        
        <mxCell id="p6-desc" value="Le microfront Vue3 se charge, rÃ©cupÃ¨re le contexte depuis l'URL, puis appelle les APIs mÃ©tier CACF avec le Bearer token pour afficher les donnÃ©es du crÃ©dit renouvelable." style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;strokeWidth=2;fontSize=13;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="100" y="4130" width="3000" height="40" as="geometry"/>
        </mxCell>
        
        <!-- 6.1 -->
        <mxCell id="a6-1" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#6A1B9A;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1755" y="4210" as="sourcePoint"/>
            <mxPoint x="1985" y="4210" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l6-1" value="1ï¸âƒ£5ï¸âƒ£ GET /refresh-token" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#6A1B9A;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1790" y="4185" width="150" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d6-1" value="Cookie: refreshToken={...}&#xa;â†’ BFF Ã©change refresh_token contre access_token (OAuth 2.0)&#xa;â†’ Returns: {access_token: '...', expires_in: 3600}" style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#F3E5F5;strokeColor=#6A1B9A;fontSize=10;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1790" y="4240" width="350" height="60" as="geometry"/>
        </mxCell>
        
        <!-- 6.2 -->
        <mxCell id="a6-2" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#388E3C;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1995" y="4340" as="sourcePoint"/>
            <mxPoint x="2465" y="4340" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l6-2" value="1ï¸âƒ£6ï¸âƒ£ GET /CustomerInfo" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#388E3C;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2120" y="4315" width="160" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d6-2" value="GET /CustomerInformation/v1/contracts/{contractId}/customers&#xa;Authorization: Bearer {access_token}&#xa;&#xa;â†’ Returns: customerId, firstName, lastName, email, address..." style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#E8F5E9;strokeColor=#2E7D32;fontSize=10;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2120" y="4370" width="400" height="70" as="geometry"/>
        </mxCell>
        
        <!-- 6.3 -->
        <mxCell id="a6-3" value="" style="endArrow=classic;html=1;strokeWidth=5;strokeColor=#388E3C;shadow=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1995" y="4470" as="sourcePoint"/>
            <mxPoint x="2465" y="4470" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="l6-3" value="1ï¸âƒ£7ï¸âƒ£ GET /RevolvingContract" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#388E3C;strokeWidth=2;fontSize=11;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2100" y="4445" width="190" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="d6-3" value="GET /revolvingContract/v1/contracts/{contractId}&#xa;Authorization: Bearer {access_token}&#xa;&#xa;â†’ Returns: status, creditLimit, availableCredit, usedCredit,&#xa;            interestRate, monthlyPayment..." style="shape=note;whiteSpace=wrap;html=1;size=12;fillColor=#E8F5E9;strokeColor=#2E7D32;fontSize=10;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2100" y="4500" width="420" height="80" as="geometry"/>
        </mxCell>
        
        <!-- 6.4 Final Display -->
        <mxCell id="final-display" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#2E7D32;strokeWidth=4;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1320" y="4340" width="600" height="200" as="geometry"/>
        </mxCell>
        <mxCell id="final-display-title" value="ðŸŽ‰ AFFICHAGE FINAL DANS LE MICROFRONT VUE3" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=14;fontStyle=1;fontColor=#1B5E20" vertex="1" parent="1">
          <mxGeometry x="1320" y="4350" width="600" height="22" as="geometry"/>
        </mxCell>
        <mxCell id="final-display-data" value="âœ… DonnÃ©es client: Jean DUPONT, jean.dupont@example.com&#xa;âœ… Contrat 70067497211: ACTIF&#xa;âœ… Limite crÃ©dit: 5 000,00 â‚¬&#xa;âœ… CrÃ©dit disponible: 3 200,00 â‚¬ (utilisÃ©: 1 800,00 â‚¬)&#xa;âœ… Taux: 18,50% | MensualitÃ©: 120,00 â‚¬&#xa;âœ… Prochaine Ã©chÃ©ance: 15/12/2025&#xa;âœ… RIB: FR76 1234 5678 9012...&#xa;âœ… Historique transactions disponible" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1340" y="4380" width="560" height="150" as="geometry"/>
        </mxCell>
        
        <!-- ==================== LÃ‰GENDE EXHAUSTIVE ==================== -->
        <mxCell id="legend-bg" value="" style="rounded=2;whiteSpace=wrap;html=1;fillColor=#FAFAFA;strokeColor=#424242;strokeWidth=5;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="4600" width="3120" height="580" as="geometry"/>
        </mxCell>
        
        <mxCell id="legend-main-title" value="ðŸ“š LÃ‰GENDE COMPLÃˆTE ET GUIDE DE LECTURE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#263238;strokeColor=none;fontColor=#FFFFFF;fontSize=22;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="60" y="4620" width="3080" height="50" as="geometry"/>
        </mxCell>
        
        <!-- Section Acteurs -->
        <mxCell id="legend-actors-section" value="ACTEURS DU SYSTÃˆME" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=16;fontStyle=1;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="80" y="4690" width="700" height="25" as="geometry"/>
        </mxCell>
        
        <mxCell id="leg-a1" value="ðŸ‘¤ Utilisateur Client" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#1976D2;strokeColor=#0D47A1;strokeWidth=2;fontColor=#FFFFFF;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="4725" width="150" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="leg-a2" value="ðŸŒ Portail Caisse" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#388E3C;strokeColor=#1B5E20;strokeWidth=2;fontColor=#FFFFFF;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="240" y="4725" width="150" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="leg-a3" value="ðŸ” IdP Caisse OIDC" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F9A825;strokeColor=#F57F17;strokeWidth=2;fontColor=#FFFFFF;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="400" y="4725" width="150" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="leg-a4" value="ðŸš€ Lanceur MyCA" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#8E24AA;strokeColor=#4A148C;strokeWidth=2;fontColor=#FFFFFF;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="560" y="4725" width="150" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="leg-a5" value="âš™ï¸ BFF Lanceur" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#D32F2F;strokeColor=#B71C1C;strokeWidth=2;fontColor=#FFFFFF;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="4765" width="150" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="leg-a6" value="ðŸ’» Microfront Vue3" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#6A1B9A;strokeColor=#4A148C;strokeWidth=2;fontColor=#FFFFFF;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="240" y="4765" width="150" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="leg-a7" value="ðŸ”§ BFF Node.js 22" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#EF6C00;strokeColor=#E65100;strokeWidth=2;fontColor=#FFFFFF;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="400" y="4765" width="150" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="leg-a8" value="ðŸ”‘ IdP CACF WSO2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#0288D1;strokeColor=#01579B;strokeWidth=2;fontColor=#FFFFFF;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="560" y="4765" width="150" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="leg-a9" value="ðŸ“Š APIs MÃ©tier CACF" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#388E3C;strokeColor=#1B5E20;strokeWidth=2;fontColor=#FFFFFF;fontSize=11;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="4805" width="150" height="30" as="geometry"/>
        </mxCell>
        
        <!-- Section Types de Flux -->
        <mxCell id="legend-flows-section" value="TYPES DE COMMUNICATIONS" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=16;fontStyle=1;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="800" y="4690" width="600" height="25" as="geometry"/>
        </mxCell>
        
        <mxCell id="leg-flow1" value="Auth OIDC (Authorization Code)" style="endArrow=classic;html=1;strokeWidth=4;strokeColor=#F9A825;shadow=1;" edge="1" parent="1">
          <mxGeometry x="0.1" y="10" width="50" height="50" relative="1" as="geometry">
            <mxPoint x="820" y="4735" as="sourcePoint"/>
            <mxPoint x="1020" y="4735" as="targetPoint"/>
            <mxPoint as="offset"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="leg-flow2" value="JWT signÃ© (certificats X.509)" style="endArrow=classic;html=1;strokeWidth=4;strokeColor=#EF6C00;shadow=1;" edge="1" parent="1">
          <mxGeometry x="0.1" y="10" width="50" height="50" relative="1" as="geometry">
            <mxPoint x="820" y="4775" as="sourcePoint"/>
            <mxPoint x="1020" y="4775" as="targetPoint"/>
            <mxPoint as="offset"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="leg-flow3" value="Redirection HTTP 302" style="endArrow=classic;html=1;strokeWidth=4;strokeColor=#8E24AA;dashed=1;dashPattern=8 4;shadow=1;" edge="1" parent="1">
          <mxGeometry x="0.1" y="10" width="50" height="50" relative="1" as="geometry">
            <mxPoint x="820" y="4815" as="sourcePoint"/>
            <mxPoint x="1020" y="4815" as="targetPoint"/>
            <mxPoint as="offset"/>
          </mxGeometry>
        </mxCell>
        
        <!-- Section Concepts -->
        <mxCell id="legend-concepts-section" value="CONCEPTS TECHNIQUES ESSENTIELS" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=16;fontStyle=1;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1480" y="4690" width="600" height="25" as="geometry"/>
        </mxCell>
        
        <mxCell id="concept-sso-leg" value="ðŸ”„ SSO : Une authentification, toutes les apps (session rÃ©utilisÃ©e)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#2E7D32;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1500" y="4725" width="450" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="concept-jwt-leg" value="ðŸŽ« JWT : Token signÃ© (header + payload + signature RS256)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#E65100;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1500" y="4765" width="450" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="concept-x5c-leg" value="ðŸ“œ x5c : 3 certificats X.509 (Lanceur â†’ CA â†’ Root)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1500" y="4805" width="450" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="concept-fidp-leg" value="ðŸ”— fidp : FÃ©dÃ©ration (WSO2 fait confiance Ã  IdP caisse)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1F5FE;strokeColor=#0277BD;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2000" y="4725" width="450" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="concept-bearer-leg" value="ðŸ”‘ Bearer Token : Access token OAuth (valide 1h)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2000" y="4765" width="450" height="30" as="geometry"/>
        </mxCell>
        
                <mxCell id="concept-transco-leg" value="ðŸ”„ Transcodage : Conversion ID Caisse â†’ ID CACF" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#7B1FA2;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2000" y="4805" width="450" height="30" as="geometry"/>
        </mxCell>
        
        <!-- Section Points ClÃ©s -->
        <mxCell id="legend-keypoints-section" value="â­ POINTS CLÃ‰S Ã€ RETENIR" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=16;fontStyle=1;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="80" y="4870" width="600" height="25" as="geometry"/>
        </mxCell>
        
        <mxCell id="key1" value="1ï¸âƒ£ Le JWT n'est JAMAIS validÃ© dans decodeNpcContext, seulement stockÃ©" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1976D2;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="4905" width="520" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="key2" value="2ï¸âƒ£ La validation JWT (6 niveaux) se fait dans transcodeContext aprÃ¨s OIDC" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1976D2;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="4945" width="520" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="key3" value="3ï¸âƒ£ Le SSO permet de ne s'authentifier QU'UNE SEULE FOIS (transparence)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1976D2;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="4985" width="520" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="key4" value="4ï¸âƒ£ WSO2 DÃ‰LÃˆGUE l'authentification Ã  l'IdP caisse via fidp (fÃ©dÃ©ration)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1976D2;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="5025" width="520" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="key5" value="5ï¸âƒ£ Il y a 3 codes d'autorisation diffÃ©rents (Portail, Lanceur, WSO2)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1976D2;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="5065" width="520" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="key6" value="6ï¸âƒ£ Le transcodage convertit les identifiants Caisse en identifiants CACF" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1976D2;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="5105" width="520" height="30" as="geometry"/>
        </mxCell>
        
        <!-- Section DurÃ©es -->
        <mxCell id="legend-durations-section" value="â±ï¸ DURÃ‰ES DE VALIDITÃ‰" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=16;fontStyle=1;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="650" y="4870" width="600" height="25" as="geometry"/>
        </mxCell>
        
        <mxCell id="duration1" value="â±ï¸ Codes d'autorisation : 5 minutes (usage unique)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="650" y="4905" width="450" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="duration2" value="â±ï¸ JWT Lanceur : 5 minutes (exp dans payload)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="650" y="4945" width="450" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="duration3" value="â±ï¸ Access Token OAuth : 1 heure (3600s)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="650" y="4985" width="450" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="duration4" value="â±ï¸ Refresh Token : 30 jours (2592000s)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="650" y="5025" width="450" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="duration5" value="â±ï¸ Cookie refreshToken : 5 minutes (300000ms)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="650" y="5065" width="450" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="duration6" value="â±ï¸ Session Express : Jusqu'Ã  fermeture navigateur" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="650" y="5105" width="450" height="30" as="geometry"/>
        </mxCell>
        
        <!-- Section URLs -->
        <mxCell id="legend-urls-section" value="ðŸŒ URLS PRINCIPALES" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=16;fontStyle=1;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1150" y="4870" width="600" height="25" as="geometry"/>
        </mxCell>
        
        <mxCell id="url1" value="ðŸŒ Portail : hom1-npc.credit-agricole.fr/ca-centrest/" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#2E7D32;strokeWidth=2;fontSize=10;align=left;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1150" y="4905" width="500" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="url2" value="ðŸ” IdP Caisse : hom-client.ca-connect.credit-agricole.fr" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFDE7;strokeColor=#F57F17;strokeWidth=2;fontSize=10;align=left;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1150" y="4945" width="500" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="url3" value="ðŸš€ Lanceur : hom1-lanceur-sav-crtconso.credit-agricole.fr" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#7B1FA2;strokeWidth=2;fontSize=10;align=left;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1150" y="4985" width="500" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="url4" value="ðŸ’» Microfront : rct.sav-crtconso.credit-agricole.fr/summary/" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#6A1B9A;strokeWidth=2;fontSize=10;align=left;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1150" y="5025" width="500" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="url5" value="ðŸ”‘ IdP WSO2 : rct-api-ca-cf.credit-agricole.fr" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1F5FE;strokeColor=#0277BD;strokeWidth=2;fontSize=10;align=left;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1150" y="5065" width="500" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="url6" value="ðŸ“Š APIs : rct-api.sofinco.fr" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;strokeWidth=2;fontSize=10;align=left;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1150" y="5105" width="500" height="30" as="geometry"/>
        </mxCell>
        
        <!-- Section SÃ©curitÃ© -->
        <mxCell id="legend-security-section" value="ðŸ›¡ï¸ MÃ‰CANISMES DE SÃ‰CURITÃ‰" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=16;fontStyle=1;fontColor=#263238" vertex="1" parent="1">
          <mxGeometry x="1700" y="4870" width="600" height="25" as="geometry"/>
        </mxCell>
        
        <mxCell id="security1" value="ðŸ›¡ï¸ Signature RS256 : Algorithme asymÃ©trique (clÃ© privÃ©e/publique)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1700" y="4905" width="560" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="security2" value="ðŸ›¡ï¸ PKI : Infrastructure Ã  clÃ©s publiques (chaÃ®ne de confiance)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1700" y="4945" width="560" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="security3" value="ðŸ›¡ï¸ HttpOnly Cookie : Protection XSS (pas accessible depuis JS)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1700" y="4985" width="560" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="security4" value="ðŸ›¡ï¸ State Parameter : Protection CSRF (Cross-Site Request Forgery)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1700" y="5025" width="560" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="security5" value="ðŸ›¡ï¸ Correlation ID : TraÃ§abilitÃ© complÃ¨te du flux (logs)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1700" y="5065" width="560" height="30" as="geometry"/>
        </mxCell>
        
        <mxCell id="security6" value="ðŸ›¡ï¸ Whitelist DN : Seuls certificats autorisÃ©s acceptÃ©s" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;strokeWidth=2;fontSize=11;align=left;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1700" y="5105" width="560" height="30" as="geometry"/>
        </mxCell>
        
        <!-- Note importante finale -->
        <mxCell id="final-important-note" value="âš ï¸ NOTE IMPORTANTE : Ce diagramme dÃ©taille TOUS les appels techniques. En production avec SSO actif, l'utilisateur ne voit qu'un chargement instantanÃ© car les sessions sont rÃ©utilisÃ©es automatiquement. Le flux complet ne se produit que lors de la PREMIÃˆRE authentification ou aprÃ¨s expiration des sessions." style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=4;fontSize=13;fontStyle=1;align=center;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2320" y="4905" width="800" height="230" as="geometry"/>
        </mxCell>
        
        <!-- RÃ©sumÃ© visuel du flux -->
        <mxCell id="flow-summary-title" value="ðŸ“Š RÃ‰SUMÃ‰ VISUEL DU FLUX COMPLET" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#37474F;strokeColor=none;fontColor=#FFFFFF;fontSize=14;fontStyle=1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2320" y="4690" width="800" height="35" as="geometry"/>
        </mxCell>
        
        <mxCell id="flow-summary-content" value="ðŸ”µ Phase 1 (Ã©tapes 1-5) : Auth initiale portail â†’ Session SSO&#xa;ðŸŸ£ Phase 2 (Ã©tapes 6-9) : Lanceur â†’ Auth Lanceur â†’ JWT signÃ©&#xa;ðŸŸ  Phase 3 (Ã©tape 10) : JWT transmis au BFF CACF (stockage session)&#xa;ðŸ”µ Phase 4 (Ã©tapes 11-14) : FÃ©dÃ©ration WSO2 â†” IdP Caisse â†’ Code final&#xa;ðŸ”´ Phase 5 (validation) : 6 niveaux sÃ©curitÃ© + transcodage + tokens&#xa;ðŸŸ¢ Phase 6 (Ã©tapes 15-17) : Refresh token + APIs mÃ©tier â†’ Affichage&#xa;&#xa;â±ï¸ DurÃ©e totale premiÃ¨re fois : ~3-5 secondes&#xa;â±ï¸ DurÃ©e avec SSO actif : &lt;500ms (quasi instantanÃ©)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ECEFF1;strokeColor=#37474F;strokeWidth=2;fontSize=11;align=left;fontFamily=Courier New;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="2330" y="4735" width="780" height="150" as="geometry"/>
        </mxCell>
        
        <!-- Footer -->
        <mxCell id="footer" value="Â© 2025 - Documentation Technique CACF/CAPFM - Flux OIDC Multi-Tenant CrÃ©dit Renouvelable | Version 1.0 ComplÃ¨te" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=2;fontColor=#666666" vertex="1" parent="1">
          <mxGeometry x="40" y="5150" width="3120" height="30" as="geometry"/>
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>

